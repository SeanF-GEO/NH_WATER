<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>NH Biodiversity Explorer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root {
  /* ‚îÄ‚îÄ New palette ‚îÄ‚îÄ */
  --void: #092018;
  --night: #104928;
  --dusk: #324939;
  --twilight: #325f5a;
  --mist: #404038;
  --fog: #689f99;

  --teal: #37887f;
  --teal-lt: #689f99;
  --sage: #98c1b1;
  --dk-teal: #325f5a;
  --brown: #6c391e;
  --brown-lt: #86593c;

  --inat: #85bb40;

  --text1: #d8ece4;
  --text2: #98c1b1;
  --text3: #689f99;
  --bdr: #325f5a;
  --bdr2: #37887f;

  --fd: 'Cormorant Garamond', Georgia, serif;
  --fb: 'Outfit', system-ui, sans-serif;
  --sb: 400px;
  --rad: 10px;
  --ease: cubic-bezier(.25,.46,.45,.94);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: var(--fb); background: var(--void); color: var(--text1); -webkit-font-smoothing: antialiased; }

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar { position: fixed; top: 0; left: 0; width: var(--sb); height: 100vh; background: var(--night); border-right: 2px solid var(--bdr); display: flex; flex-direction: column; z-index: 1000; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--fog) transparent; }
.sidebar::-webkit-scrollbar { width: 6px; } .sidebar::-webkit-scrollbar-thumb { background: var(--fog); border-radius: 3px; }

.sb-hd { padding: 32px 30px 26px; border-bottom: 2px solid var(--bdr); position: relative; overflow: hidden; }
.sb-hd::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 25% 80%, rgba(55,136,127,.2), transparent 55%), radial-gradient(ellipse at 75% 15%, rgba(108,57,30,.15), transparent 50%); pointer-events: none; }
.hd-eye { font-size: .7rem; font-weight: 600; letter-spacing: .24em; text-transform: uppercase; color: var(--teal); margin-bottom: 10px; position: relative; }
.hd-t { font-family: var(--fd); font-size: 2.2rem; font-weight: 700; line-height: 1.08; color: #e8f4ef; position: relative; }
.hd-s { font-family: var(--fd); font-size: 1.1rem; font-weight: 400; font-style: italic; color: var(--sage); margin-top: 6px; position: relative; }

/* ‚ïê‚ïê‚ïê PANELS ‚ïê‚ïê‚ïê */
.pnl { padding: 22px 30px; border-bottom: 2px solid var(--bdr); }
.pnl-lb { display: flex; align-items: center; gap: 10px; font-size: .72rem; font-weight: 600; letter-spacing: .16em; text-transform: uppercase; color: var(--text3); margin-bottom: 14px; }
.sn { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: .7rem; font-weight: 700; color: var(--sage); border: 1px solid var(--bdr2); background: var(--dusk); }
.sn.on { background: var(--brown); color: #e8f4ef; border-color: var(--brown-lt); }

/* ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê */
.sw { position: relative; }
.si-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text3); pointer-events: none; transition: color .2s; }
.sinp { width: 100%; padding: 14px 18px 14px 46px; background: var(--dusk); border: 2px solid var(--bdr); border-radius: var(--rad); color: var(--text1); font-family: var(--fb); font-size: 1.05rem; outline: none; transition: border-color .3s, box-shadow .3s; }
.sinp::placeholder { color: var(--text3); font-weight: 300; }
.sinp:focus { border-color: var(--teal); box-shadow: 0 0 0 3px rgba(55,136,127,.2); }
.sinp:focus ~ .si-icon { color: var(--teal); }
.shint { font-size: .82rem; color: var(--text3); margin-top: 10px; font-style: italic; font-family: var(--fd); }

/* ‚ïê‚ïê‚ïê SUGGESTIONS ‚ïê‚ïê‚ïê */
.sugs { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: var(--dusk); border: 2px solid var(--bdr2); border-radius: var(--rad); max-height: 360px; overflow-y: auto; z-index: 100; box-shadow: 0 16px 50px rgba(0,0,0,.5); display: none; }
.sugs.open { display: block; }
.sg { padding: 12px 18px; cursor: pointer; border-bottom: 1px solid var(--bdr); transition: background .12s; display: flex; align-items: center; gap: 14px; }
.sg:last-child { border-bottom: none; } .sg:hover { background: var(--twilight); }
.sg-img { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: var(--void); flex-shrink: 0; border: 1px solid var(--bdr); }
.sg-info { flex: 1; min-width: 0; }
.sg-c { font-size: 1.02rem; font-weight: 600; color: #e8f4ef; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sg-s { font-size: .88rem; color: var(--sage); font-style: italic; font-family: var(--fd); }
.sg-r { font-size: .62rem; font-weight: 600; letter-spacing: .06em; text-transform: uppercase; color: var(--teal); background: rgba(55,136,127,.12); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(55,136,127,.25); flex-shrink: 0; }

/* ‚ïê‚ïê‚ïê BADGE ‚ïê‚ïê‚ïê */
.badge { margin-top: 16px; padding: 14px 18px; background: linear-gradient(135deg, rgba(55,136,127,.12), rgba(108,57,30,.08)); border: 2px solid rgba(55,136,127,.25); border-radius: var(--rad); display: none; align-items: center; gap: 14px; animation: fu .35s var(--ease); }
.badge.vis { display: flex; }
@keyframes fu { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
.b-img { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; background: var(--void); border: 1px solid var(--bdr); }
.b-txt { flex: 1; min-width: 0; }
.b-c { font-weight: 600; font-size: 1.05rem; color: var(--brown-lt); }
.b-s { font-size: .88rem; color: var(--sage); font-style: italic; font-family: var(--fd); }
.b-x { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 1.5rem; line-height: 1; padding: 4px; border-radius: 4px; transition: color .15s; }
.b-x:hover { color: var(--teal); }

/* ‚ïê‚ïê‚ïê TOGGLES ‚ïê‚ïê‚ïê */
.tg { display: flex; flex-direction: column; gap: 6px; }
.tl { display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: .98rem; color: var(--text2); user-select: none; padding: 5px 0; }
.tl input { display: none; }
.tt { width: 38px; height: 20px; background: var(--void); border: 2px solid var(--bdr); border-radius: 10px; position: relative; flex-shrink: 0; transition: background .25s, border-color .25s; }
.tt::after { content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: var(--text3); border-radius: 50%; transition: transform .25s var(--ease), background .25s; }
.tl input:checked + .tt { background: rgba(55,136,127,.2); border-color: var(--teal); }
.tl input:checked + .tt::after { transform: translateX(18px); background: var(--teal); }
.tl-lb { display: flex; align-items: center; gap: 8px; }
.sd { width: 9px; height: 9px; border-radius: 50%; } .sd.i { background: var(--inat); }

/* ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê */
.rp { display: none; } .rp.vis { display: block; }
.rs { margin-bottom: 20px; }
.rs h4 { font-family: var(--fd); font-size: 1.15rem; font-weight: 700; color: #e8f4ef; margin-bottom: 12px; }
.rr { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; cursor: pointer; }
.rr:hover .rn { color: #e8f4ef; }
.rn { color: var(--text2); font-size: .95rem; max-width: 210px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color .15s; }
.rv { font-weight: 700; font-size: .98rem; font-variant-numeric: tabular-nums; color: var(--brown-lt); }
.rb { height: 5px; background: var(--bdr); border-radius: 3px; margin: 4px 0 10px; overflow: hidden; }
.rb-f { height: 100%; border-radius: 3px; transition: width .6s var(--ease); }
.hero-card { padding: 12px 16px; background: linear-gradient(135deg, rgba(55,136,127,.12), rgba(108,57,30,.08)); border: 2px solid rgba(55,136,127,.25); border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: background .2s; }
.hero-card:hover { background: linear-gradient(135deg, rgba(55,136,127,.22), rgba(108,57,30,.14)); }
.hero-name { font-family: var(--fd); font-size: 1.15rem; font-weight: 700; color: var(--brown-lt); }
.hero-sub { font-size: .9rem; color: var(--text2); }
.hero-hint { font-size: .78rem; color: var(--teal); margin-top: 4px; font-style: italic; }

/* ‚ïê‚ïê‚ïê BACK BUTTON ‚ïê‚ïê‚ïê */
.back-btn { display: none; margin-bottom: 14px; padding: 10px 16px; background: var(--void); border: 2px solid var(--bdr2); border-radius: 8px; color: var(--sage); font-family: var(--fb); font-size: .95rem; cursor: pointer; transition: background .2s, border-color .2s; width: 100%; text-align: left; }
.back-btn:hover { background: var(--dusk); border-color: var(--teal); }
.back-btn.vis { display: block; }

/* ‚ïê‚ïê‚ïê TRAIL INFO ‚ïê‚ïê‚ïê */
.trail-info { margin-top: 14px; padding: 12px 16px; background: linear-gradient(135deg, rgba(134,89,60,.1), rgba(55,136,127,.06)); border: 2px solid rgba(134,89,60,.25); border-radius: 8px; display: none; }
.trail-info.vis { display: block; }
.trail-info h5 { font-family: var(--fd); font-size: 1.05rem; font-weight: 700; color: var(--brown-lt); margin-bottom: 8px; }
.trail-info .trail-count { font-size: .88rem; color: var(--text2); margin-bottom: 8px; }
.trail-item { font-size: .9rem; color: var(--text2); padding: 4px 0; border-bottom: 1px solid var(--bdr); display: flex; justify-content: space-between; }
.trail-item:last-child { border-bottom: none; }
.trail-item .tn { color: #e8f4ef; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.trail-item .to { color: var(--brown-lt); font-weight: 600; }

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
.sb-ft { margin-top: auto; padding: 20px 30px; border-top: 2px solid var(--bdr); background: var(--void); }
.st-r { display: flex; justify-content: space-between; }
.stat { text-align: center; }
.st-v { display: block; font-family: var(--fd); font-size: 1.6rem; font-weight: 700; color: var(--brown-lt); line-height: 1.2; }
.st-l { font-size: .68rem; letter-spacing: .1em; text-transform: uppercase; color: var(--text3); font-weight: 500; }

/* ‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê */
#map { position: fixed; top: 0; left: var(--sb); right: 0; bottom: 0; z-index: 1; background: var(--void); }

/* ‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê */
.ld { position: fixed; top: 0; left: var(--sb); right: 0; bottom: 0; background: rgba(9,32,24,.88); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 2000; }
.ld.vis { display: flex; }
.sp { width: 42px; height: 42px; border: 3px solid var(--bdr); border-top-color: var(--teal); border-radius: 50%; animation: spin .7s linear infinite; margin: 0 auto 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.lm { font-size: 1rem; color: var(--sage); font-family: var(--fd); font-style: italic; }

/* ‚ïê‚ïê‚ïê LEAFLET OVERRIDES ‚ïê‚ïê‚ïê */
.leaflet-popup-content-wrapper { background: var(--dusk) !important; color: var(--text1) !important; border-radius: var(--rad) !important; border: 2px solid var(--bdr2) !important; box-shadow: 0 12px 45px rgba(0,0,0,.5) !important; }
.leaflet-popup-tip { background: var(--dusk) !important; }
.leaflet-popup-content { font-family: var(--fb) !important; font-size: .95rem !important; line-height: 1.6 !important; margin: 14px 18px !important; }
.leaflet-popup-content strong { color: var(--brown-lt); font-family: var(--fd); font-size: 1.1rem; }
.leaflet-popup-content a { color: var(--sage); text-decoration: none; }
.leaflet-popup-content a:hover { text-decoration: underline; }
.leaflet-popup-close-button { color: var(--text3) !important; font-size: 20px !important; }
.leaflet-control-zoom a { background: var(--dusk) !important; color: #e8f4ef !important; border-color: var(--bdr) !important; }
.leaflet-control-zoom a:hover { background: var(--twilight) !important; }
.leaflet-control-attribution { background: rgba(9,32,24,.9) !important; color: var(--text3) !important; font-size: .6rem !important; }
.leaflet-control-attribution a { color: var(--sage) !important; }

/* ‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê */
.legend { background: var(--dusk); border: 2px solid var(--bdr2); border-radius: var(--rad); padding: 16px 20px; font-size: .82rem; color: var(--text2); line-height: 2; }
.legend-t { font-weight: 600; font-size: .68rem; letter-spacing: .12em; text-transform: uppercase; color: var(--text3); margin-bottom: 4px; }
.legend-r { display: flex; align-items: center; gap: 10px; }
.legend-s { width: 22px; height: 12px; border-radius: 3px; flex-shrink: 0; border: 1px solid rgba(255,255,255,.08); }

/* ‚ïê‚ïê‚ïê TOOLTIPS ‚ïê‚ïê‚ïê */
.ws-tip { background: var(--dusk) !important; color: #e8f4ef !important; border: 2px solid var(--bdr2) !important; border-radius: 6px !important; padding: 5px 12px !important; font-family: var(--fd) !important; font-size: 1rem !important; font-weight: 600 !important; box-shadow: 0 6px 20px rgba(0,0,0,.4) !important; }
.trail-tip { background: rgba(134,89,60,.92) !important; color: #f0e8df !important; border: none !important; border-radius: 4px !important; padding: 3px 10px !important; font-family: var(--fb) !important; font-size: .82rem !important; font-weight: 600 !important; box-shadow: 0 2px 8px rgba(0,0,0,.3) !important; white-space: nowrap !important; }

/* ‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê */
@media (max-width: 800px) { :root { --sb: 100vw; } .sidebar { width: 100%; height: auto; max-height: 42vh; position: relative; } #map { position: relative; left: 0; height: 58vh; } body { overflow-y: auto; } .ld { left: 0; } }
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sb-hd">
    <div class="hd-eye">New Hampshire</div>
    <h1 class="hd-t">Biodiversity Explorer</h1>
    <p class="hd-s">Watersheds, Wildlife &amp; Trails</p>
  </div>

  <div class="pnl">
    <label class="pnl-lb"><span class="sn on">1</span>Find a Species</label>
    <div class="sw">
      <svg class="si-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
      <input type="text" id="inp" class="sinp" placeholder="Black Bear, Moose, Bald Eagle‚Ä¶" autocomplete="off"/>
      <div id="sugs" class="sugs"></div>
    </div>
    <div class="shint">Type a common or scientific name</div>
    <div id="badge" class="badge">
      <img id="bImg" class="b-img" src="" alt=""/>
      <div class="b-txt"><div id="bC" class="b-c"></div><div id="bS" class="b-s"></div></div>
      <button id="bX" class="b-x">&times;</button>
    </div>
  </div>

  <div class="pnl">
    <label class="pnl-lb"><span class="sn">2</span>Layers</label>
    <div class="tg">
      <label class="tl"><input type="checkbox" id="tWS" checked/><span class="tt"></span><span class="tl-lb">Watersheds</span></label>
      <label class="tl"><input type="checkbox" id="tPt" checked/><span class="tt"></span><span class="tl-lb"><span class="sd i"></span>Observation Points</span></label>
      <label class="tl"><input type="checkbox" id="tHt"/><span class="tt"></span><span class="tl-lb">Heatmap</span></label>
    </div>
  </div>

  <div class="pnl rp" id="resP">
    <label class="pnl-lb"><span class="sn on">3</span>Results</label>
    <button id="backBtn" class="back-btn">&#8592; Back to all watersheds</button>
    <div id="resC"></div>
    <div id="trailInfo" class="trail-info">
      <h5 id="trailTitle">Trails</h5>
      <div id="trailCount" class="trail-count"></div>
      <div id="trailList"></div>
    </div>
  </div>

  <div class="sb-ft">
    <div class="st-r">
      <div class="stat"><span class="st-v" id="sO">&mdash;</span><span class="st-l">Observations</span></div>
      <div class="stat"><span class="st-v" id="sW">&mdash;</span><span class="st-l">Watersheds</span></div>
      <div class="stat"><span class="st-v" id="sT">&mdash;</span><span class="st-l">Trails</span></div>
    </div>
  </div>
</aside>

<div id="map"></div>
<div id="ld" class="ld"><div><div class="sp"></div><p class="lm" id="lmsg">Loading‚Ä¶</p></div></div>

<script>
(async function() {
'use strict';

const NH = { swlat: 42.697, swlng: -72.557, nelat: 45.305, nelng: -70.703 };
const INAT = 'https://api.inaturalist.org/v1';

const TRAIL_FILES = {
  'Ammonoosuc River-Connecticut River': 'Trails_Ammonoosuc_River_Connecticut_River.geojson',
  'Ashuelot River-Connecticut River': 'Trails_Ashuelot_River_Connecticut_River.geojson',
  'Black River-Connecticut River': 'Trails_Black_River_Connecticut_River.geojson',
  'Contoocook River': 'Trails_Contoocook_River.geojson',
  'Headwaters Connecticut River': 'Trails_Headwaters_Connecticut_River.geojson',
  'Lower Androscoggin River': 'Trails_Lower_Androscoggin_River.geojson',
  'Merrimack River': 'Trails_Merrimack_River.geojson',
  'Millers River': 'Trails_Millers_River.geojson',
  'Nashua River': 'Trails_Nashua_River.geojson',
  'Pemigewasset River': 'Trails_Pemigewasset_River.geojson',
  'Piscataqua-Salmon Falls': 'Trails_Piscataqua_Salmon_Falls.geojson',
  'Saco River': 'Trails_Saco_River.geojson',
  'Upper Androscoggin River': 'Trails_Upper_Androscoggin_River.geojson',
  'Waits River-Connecticut River': 'Trails_Waits_River_Connecticut_River.geojson',
  'West River-Connecticut River': 'Trails_West_River_Connecticut_River.geojson',
  'Winnipesaukee River': 'Trails_Winnipesaukee_River.geojson'
};

/* Watershed outline colors from palette */
const WC = ['#37887f','#689f99','#325f5a','#98c1b1','#37887f','#689f99','#325f5a',
            '#98c1b1','#37887f','#689f99','#325f5a','#98c1b1','#37887f','#689f99',
            '#325f5a','#98c1b1','#37887f'];
/* Density fill colors */
const DC = ['rgba(50,73,57,0.08)','rgba(55,136,127,0.12)','rgba(55,136,127,0.22)','rgba(134,89,60,0.30)','rgba(108,57,30,0.40)','rgba(108,57,30,0.55)'];
const DB = [0, 1, 5, 15, 40, 100];

const $ = id => document.getElementById(id);
function sL(m) { $('lmsg').textContent = m; $('ld').classList.add('vis'); }
function hL() { $('ld').classList.remove('vis'); }
async function fj(p) {
  try { const r = await fetch(p); if (!r.ok) throw r.status; return r.json(); }
  catch(e) { console.warn('Failed:', p, e); return null; }
}

/* ‚ïê‚ïê‚ïê REPROJECTION ‚ïê‚ïê‚ïê */
proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +no_defs');
proj4.defs('EPSG:3437', '+proj=tmerc +lat_0=42.5 +lon_0=-71.66666666666667 +k=0.999966667 +x_0=300000.0000000001 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs');

function reprojectCoords(coords, fromCRS) {
  if (typeof coords[0] === 'number') return proj4(fromCRS, 'EPSG:4326', [coords[0], coords[1]]);
  return coords.map(c => reprojectCoords(c, fromCRS));
}
function detectCRS(gj) {
  const n = gj?.crs?.properties?.name || '';
  if (n.includes('3857')) return 'EPSG:3857';
  if (n.includes('3437')) return 'EPSG:3437';
  if (n.includes('4326') || n.includes('4269')) return null;
  function fc(c) { if (typeof c[0] === 'number') return c; return fc(c[0]); }
  for (const f of (gj.features || [])) {
    if (f.geometry?.coordinates) {
      const c = fc(f.geometry.coordinates);
      if (c) {
        if (Math.abs(c[0]) <= 180 && Math.abs(c[1]) <= 90) return null;
        if (Math.abs(c[0]) > 100000) return 'EPSG:3857';
        if (c[0] > 50000 && c[0] < 2000000) return 'EPSG:3437';
      }
    }
  }
  return null;
}
function ensureWGS84(gj) {
  if (!gj || !gj.features) return gj;
  const from = detectCRS(gj);
  if (!from) return gj;
  console.log('Reprojecting from', from);
  const out = JSON.parse(JSON.stringify(gj));
  out.features.forEach(f => { if (f.geometry?.coordinates) f.geometry.coordinates = reprojectCoords(f.geometry.coordinates, from); });
  delete out.crs;
  return out;
}

/* ‚ïê‚ïê‚ïê TRAIL CACHE ‚ïê‚ïê‚ïê */
const trailCache = {};
async function loadTrails(wsName) {
  if (trailCache[wsName]) return trailCache[wsName];
  const file = TRAIL_FILES[wsName];
  if (!file) return null;
  const raw = await fj(file);
  if (!raw) return null;
  const gj = ensureWGS84(raw);
  gj.features.forEach(f => {
    f.properties = f.properties || {};
    f.properties._ws = wsName;
    if (!f.properties.trailname) f.properties.trailname = f.properties.TRAIL_NAME || f.properties.Name || 'Trail';
  });
  trailCache[wsName] = gj;
  return gj;
}

/* ‚ïê‚ïê‚ïê LOAD DATA ‚ïê‚ïê‚ïê */
sL('Loading watersheds‚Ä¶');
const wsRaw = await fj('nh_8.geojson');
const stRaw = await fj('State.geojson');
const wsGJ = wsRaw ? ensureWGS84(wsRaw) : null;
const stGJ = stRaw ? ensureWGS84(stRaw) : null;
if (!wsGJ) { hL(); alert('Could not load nh_8.geojson'); return; }
console.log('Loaded', wsGJ.features.length, 'watersheds');

/* ‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê */
const map = L.map('map', { center: [43.92, -71.5], zoom: 8, minZoom: 7, maxZoom: 18 });
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; CARTO &copy; OSM', maxZoom: 19
}).addTo(map);

if (stGJ) L.geoJSON(stGJ, { style: { color: '#325f5a', weight: 1.5, opacity: .4, dashArray: '6,4', fill: false }, interactive: false }).addTo(map);

const wcm = {};
wsGJ.features.forEach((f, i) => { wcm[f.properties.name] = WC[i % WC.length]; });

/* Map panes for z-order */
map.createPane('wsPane'); map.getPane('wsPane').style.zIndex = 400;
map.createPane('trailPane'); map.getPane('trailPane').style.zIndex = 450;
map.createPane('pointPane'); map.getPane('pointPane').style.zIndex = 500;

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
let lWS = null, lTr = null, lObs = null, lHeat = null;
let curSp = null, curObs = null;
let activeWatershed = null, viewMode = 'all';

/* ‚ïê‚ïê‚ïê ALL WATERSHEDS VIEW ‚ïê‚ïê‚ïê */
function showAllWatersheds(fitBounds) {
  viewMode = 'all'; activeWatershed = null;
  if (lWS) { map.removeLayer(lWS); lWS = null; }
  if (lTr) { map.removeLayer(lTr); lTr = null; }
  $('backBtn').classList.remove('vis');
  $('trailInfo').classList.remove('vis');

  const hasDensity = !!(curObs && curObs.features.length);

  lWS = L.geoJSON(wsGJ, {
    pane: 'wsPane',
    style: f => {
      const c = wcm[f.properties.name] || '#37887f';
      if (hasDensity) {
        const n = f.properties._oc || 0;
        let ci = 0;
        for (let i = DB.length - 1; i >= 0; i--) { if (n >= DB[i]) { ci = i; break; } }
        const top = f.properties._top;
        return { fillColor: DC[ci], fillOpacity: 1, color: top ? '#98c1b1' : c, weight: top ? 4 : 2.5, opacity: top ? 1 : .7 };
      }
      return { fillColor: c, fillOpacity: .08, color: c, weight: 2.5, opacity: .7 };
    },
    onEachFeature: (f, ly) => {
      ly.on({
        mouseover: e => { e.target.setStyle({ weight: 4, opacity: 1, color: '#98c1b1' }); e.target.bringToFront(); },
        mouseout: e => lWS.resetStyle(e.target),
        click: () => drillIntoWatershed(f.properties.name)
      });
      const oc = hasDensity && f.properties._oc ? ' (' + f.properties._oc + ')' : '';
      ly.bindTooltip(f.properties.name + oc, { sticky: true, className: 'ws-tip', direction: 'top', offset: [0, -10] });
    }
  });
  if ($('tWS').checked) lWS.addTo(map);
  if (fitBounds !== false) map.fitBounds(lWS.getBounds(), { padding: [20, 20] });
}

/* ‚ïê‚ïê‚ïê DRILL INTO SINGLE WATERSHED ‚ïê‚ïê‚ïê */
async function drillIntoWatershed(wsName) {
  viewMode = 'single'; activeWatershed = wsName;
  if (lWS) { map.removeLayer(lWS); lWS = null; }
  if (lTr) { map.removeLayer(lTr); lTr = null; }

  const feat = wsGJ.features.find(f => f.properties.name === wsName);
  if (!feat) return;

  const c = wcm[wsName] || '#37887f';
  lWS = L.geoJSON(feat, {
    pane: 'wsPane',
    style: { fillColor: c, fillOpacity: .06, color: c, weight: 3, opacity: .8 },
    interactive: false
  });
  lWS.addTo(map);
  map.fitBounds(lWS.getBounds(), { padding: [50, 50] });
  $('backBtn').classList.add('vis');

  sL('Loading trails for ' + wsName + '‚Ä¶');
  const trailData = await loadTrails(wsName);
  hL();

  if (!trailData || !trailData.features.length) {
    $('trailInfo').classList.add('vis');
    $('trailTitle').textContent = wsName;
    $('trailCount').textContent = 'No trail data available';
    $('trailList').innerHTML = '';
    $('sT').textContent = '0';
    return;
  }

  // Score trails
  if (curObs && curObs.features.length) {
    trailData.features.forEach(t => { t.properties._on = 0; });
    curObs.features.forEach(obs => {
      const pt = turf.point(obs.geometry.coordinates);
      trailData.features.forEach(t => {
        try { if (turf.nearestPointOnLine(t, pt).properties.dist <= 0.5) t.properties._on++; } catch(e) {}
      });
    });
  }

  const maxObs = Math.max(1, ...trailData.features.map(t => t.properties._on || 0));

  lTr = L.geoJSON(trailData, {
    pane: 'trailPane',
    style: f => {
      const on = f.properties._on || 0;
      const s = on / maxObs;
      if (curObs && on > 0) return { color: '#86593c', weight: 3 + s * 4, opacity: .5 + s * .5 };
      return { color: '#689f99', weight: 2, opacity: .45 };
    },
    onEachFeature: (f, ly) => {
      const p = f.properties;
      const name = p.trailname || 'Trail';
      ly.on('click', () => {
        const mi = p.miles ? ((+p.miles).toFixed(1) + ' mi') : '';
        const co = p.community || '';
        const ob = p._on ? '<br/>Nearby observations: <b style="color:#86593c">' + p._on + '</b>' : '';
        const url = p.mapurl ? '<br/><a href="' + p.mapurl + '" target="_blank" style="font-size:.85rem">Trail info &#8594;</a>' : '';
        ly.bindPopup('<strong>' + name + '</strong><br/><span style="color:#689f99;font-size:.85rem">' + co + (co && mi ? ' &middot; ' : '') + mi + '</span>' + ob + url).openPopup();
      });
      ly.bindTooltip(name, { sticky: true, className: 'trail-tip', direction: 'top', offset: [0, -8] });
    }
  });
  lTr.addTo(map);

  // Sidebar
  const sorted = [...trailData.features].sort((a, b) => (b.properties._on || 0) - (a.properties._on || 0));
  const withObs = sorted.filter(t => (t.properties._on || 0) > 0).slice(0, 10);
  $('trailTitle').textContent = 'Trails in ' + wsName;
  $('trailCount').textContent = trailData.features.length + ' trails';
  if (withObs.length && curObs) {
    $('trailList').innerHTML = withObs.map(t =>
      '<div class="trail-item"><span class="tn">' + (t.properties.trailname || 'Trail') + '</span><span class="to">' + t.properties._on + ' nearby</span></div>'
    ).join('');
  } else if (!curObs) {
    $('trailList').innerHTML = '<div style="font-size:.85rem;color:var(--text3);font-style:italic">Search a species to rank trails by sightings</div>';
  } else {
    $('trailList').innerHTML = '<div style="font-size:.85rem;color:var(--text3);font-style:italic">No observations near these trails</div>';
  }
  $('trailInfo').classList.add('vis');
  $('sT').textContent = trailData.features.length;
}

$('backBtn').addEventListener('click', () => showAllWatersheds());
showAllWatersheds();
hL();

/* ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê */
let sTimer;
const inp = $('inp'), sugBox = $('sugs');
inp.addEventListener('input', () => {
  clearTimeout(sTimer);
  const q = inp.value.trim();
  if (q.length < 2) { sugBox.classList.remove('open'); return; }
  sTimer = setTimeout(async () => {
    let taxa = [];
    try {
      const d = await (await fetch(INAT + '/taxa/autocomplete?q=' + encodeURIComponent(q) + '&per_page=12&is_active=true')).json();
      taxa = (d.results || []).map(t => ({
        id: t.id, sci: t.name,
        common: t.preferred_common_name || t.english_common_name || t.name,
        rank: t.rank, icon: t.default_photo?.square_url || ''
      }));
    } catch(e) {}
    if (!taxa.length) {
      sugBox.innerHTML = '<div style="padding:16px 18px;color:var(--text3);font-size:.95rem;font-family:var(--fd);font-style:italic">No species found</div>';
      sugBox.classList.add('open'); return;
    }
    sugBox.innerHTML = taxa.map(t =>
      '<div class="sg" data-id="'+t.id+'" data-sci="'+t.sci+'" data-common="'+t.common+'" data-icon="'+t.icon+'">' +
      (t.icon ? '<img class="sg-img" src="'+t.icon+'" alt=""/>' : '<div class="sg-img"></div>') +
      '<div class="sg-info"><div class="sg-c">'+t.common+'</div><div class="sg-s">'+t.sci+'</div></div>' +
      '<span class="sg-r">'+t.rank+'</span></div>'
    ).join('');
    sugBox.classList.add('open');
    sugBox.querySelectorAll('.sg').forEach(el => {
      el.addEventListener('click', () => pick({ id: el.dataset.id, sci: el.dataset.sci, common: el.dataset.common, icon: el.dataset.icon }));
    });
  }, 300);
});
inp.addEventListener('keydown', e => { if (e.key==='Enter') { e.preventDefault(); const f = sugBox.querySelector('.sg'); if (f) f.click(); }});
document.addEventListener('click', e => { if (!e.target.closest('.sw')) sugBox.classList.remove('open'); });

/* ‚ïê‚ïê‚ïê FETCH OBSERVATIONS (iNaturalist only) ‚ïê‚ïê‚ïê */
async function pick(sp) {
  curSp = sp;
  sugBox.classList.remove('open'); inp.value = '';
  $('bC').textContent = sp.common; $('bS').textContent = sp.sci;
  $('bImg').src = sp.icon || ''; $('bImg').style.display = sp.icon ? '' : 'none';
  $('badge').classList.add('vis');
  sL('Fetching ' + sp.common + ' observations‚Ä¶');

  try {
    let all = [];
    for (let pg = 1; pg <= 5; pg++) {
      const d = await (await fetch(INAT + '/observations?taxon_id=' + sp.id +
        '&swlat='+NH.swlat+'&swlng='+NH.swlng+'&nelat='+NH.nelat+'&nelng='+NH.nelng +
        '&quality_grade=research,needs_id&per_page=200&page='+pg+'&order=desc&order_by=observed_on')).json();
      const r = d.results || [];
      all = all.concat(r);
      if (r.length < 200) break;
    }

    const feats = [];
    all.filter(o => o.geojson).forEach(o => {
      feats.push({ type: 'Feature',
        geometry: { type: 'Point', coordinates: [+o.geojson.coordinates[0], +o.geojson.coordinates[1]] },
        properties: { id: o.id, src: 'iNaturalist', species: o.taxon?.name||'', common: o.taxon?.preferred_common_name||'',
          date: o.observed_on||'', user: o.user?.login||'',
          photo: o.photos?.[0]?.url?.replace('square','small')||'',
          uri: o.uri || 'https://www.inaturalist.org/observations/'+o.id }
      });
    });

    curObs = { type: 'FeatureCollection', features: feats };
    console.log('Observations:', feats.length);
    analyze();
  } catch(e) { console.error('Fetch error:', e); hL(); }
}

/* ‚ïê‚ïê‚ïê CLEAR ‚ïê‚ïê‚ïê */
$('bX').addEventListener('click', clr);
function clr() {
  curSp = null; curObs = null;
  $('badge').classList.remove('vis');
  if (lObs) { map.removeLayer(lObs); lObs = null; }
  if (lHeat) { map.removeLayer(lHeat); lHeat = null; }
  wsGJ.features.forEach(f => { delete f.properties._oc; delete f.properties._od; delete f.properties._top; });
  showAllWatersheds();
  $('sO').textContent = '‚Äî'; $('sW').textContent = '‚Äî'; $('sT').textContent = '‚Äî';
  $('resP').classList.remove('vis');
  $('trailInfo').classList.remove('vis');
}

/* ‚ïê‚ïê‚ïê ANALYZE ‚ïê‚ïê‚ïê */
function analyze() {
  if (!curObs || !curObs.features.length) {
    hL(); $('bS').textContent = curSp.sci + ' ‚Äî no observations found in NH'; return;
  }
  sL('Analyzing ' + curObs.features.length + ' observations‚Ä¶');

  setTimeout(() => {
    const pts = curObs.features;

    wsGJ.features.forEach(f => { f.properties._oc = 0; f.properties._od = 0; f.properties._top = false; });
    pts.forEach(pt => {
      const tp = turf.point(pt.geometry.coordinates);
      for (const f of wsGJ.features) {
        try { if (turf.booleanPointInPolygon(tp, f)) { f.properties._oc++; break; } } catch(e) {}
      }
    });
    wsGJ.features.forEach(f => {
      f.properties._od = +(f.properties._oc / (f.properties.areasqkm || 1)).toFixed(2);
    });
    let topWS = null, topN = 0;
    wsGJ.features.forEach(f => { if (f.properties._oc > topN) { topN = f.properties._oc; topWS = f; } });
    if (topWS) topWS.properties._top = true;

    showAllWatersheds(false);

    // Points
    if (lObs) map.removeLayer(lObs);
    lObs = L.geoJSON(curObs, {
      pane: 'pointPane',
      pointToLayer: (f, ll) => L.circleMarker(ll, {
        radius: 6, fillColor: '#85bb40', color: '#092018', weight: 1.5, fillOpacity: .85
      }),
      onEachFeature: (f, ly) => {
        const p = f.properties;
        const ph = p.photo ? '<img src="'+p.photo+'" style="width:100%;max-height:110px;object-fit:cover;border-radius:6px;margin-bottom:8px"/>' : '';
        ly.bindPopup(ph+'<strong>'+(p.common||p.species)+'</strong><br/><em style="color:#98c1b1;font-size:.85rem">'+p.species+'</em><br/><span style="color:#689f99;font-size:.85rem">iNaturalist &middot; '+(p.date||'')+(p.user?' &middot; '+p.user:'')+'</span><br/><a href="'+p.uri+'" target="_blank" style="font-size:.88rem">View observation &#8594;</a>');
      }
    });
    if ($('tPt').checked) lObs.addTo(map);

    // Heatmap
    if (lHeat) map.removeLayer(lHeat);
    lHeat = L.heatLayer(
      curObs.features.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0], 0.6]),
      { radius: 22, blur: 16, maxZoom: 14, gradient: { 0.15:'#092018', 0.35:'#325f5a', 0.55:'#37887f', 0.75:'#86593c', 1:'#6c391e' } }
    );
    if ($('tHt').checked) lHeat.addTo(map);

    // Results
    const topW = [...wsGJ.features].filter(f => f.properties._oc > 0).sort((a,b) => b.properties._oc - a.properties._oc).slice(0, 7);
    const mW = topW[0]?.properties._oc || 1;

    let h = '<div class="rs"><h4>Top Watershed</h4>';
    if (topWS && topN > 0) {
      const sn = topWS.properties.name.replace(/'/g, "\\'");
      h += '<div class="hero-card" onclick="document.dispatchEvent(new CustomEvent(\'wsClick\',{detail:\''+sn+'\'}))">' +
           '<div class="hero-name">'+topWS.properties.name+'</div>' +
           '<div class="hero-sub">'+topN+' observations &middot; '+topWS.properties._od+'/km&sup2;</div>' +
           '<div class="hero-hint">Click to view trails &#8594;</div></div>';
    }
    h += '<h4 style="margin-top:16px">Watersheds with Sightings</h4>';
    h += '<div style="font-size:.82rem;color:var(--text3);margin-bottom:10px;font-style:italic">Click any to see trails</div>';
    topW.forEach(f => {
      const pct = (f.properties._oc / mW * 100).toFixed(0);
      const sn = f.properties.name.replace(/'/g, "\\'");
      h += '<div class="rr" onclick="document.dispatchEvent(new CustomEvent(\'wsClick\',{detail:\''+sn+'\'}))">' +
           '<span class="rn">'+(f.properties._top?'&#11045; ':'')+f.properties.name+'</span><span class="rv">'+f.properties._oc+'</span></div>' +
           '<div class="rb"><div class="rb-f" style="width:'+pct+'%;background:'+(f.properties._top?'#37887f':'#404038')+'"></div></div>';
    });
    h += '</div>';

    $('resC').innerHTML = h;
    $('resP').classList.add('vis');
    $('sO').textContent = curObs.features.length.toLocaleString();
    $('sW').textContent = topW.length;
    $('sT').textContent = '‚Äî';
    hL();
  }, 60);
}

document.addEventListener('wsClick', e => drillIntoWatershed(e.detail));

/* ‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê */
const leg = L.control({ position: 'bottomright' });
leg.onAdd = function() {
  const d = L.DomUtil.create('div', 'legend');
  d.innerHTML =
    '<div class="legend-t">Observation Density</div>' +
    '<div class="legend-r"><span class="legend-s" style="background:rgba(55,136,127,0.12)"></span>Low</div>' +
    '<div class="legend-r"><span class="legend-s" style="background:rgba(55,136,127,0.22)"></span>Medium</div>' +
    '<div class="legend-r"><span class="legend-s" style="background:rgba(134,89,60,0.30)"></span>High</div>' +
    '<div class="legend-r"><span class="legend-s" style="background:rgba(108,57,30,0.55)"></span>Very High</div>' +
    '<div class="legend-t" style="margin-top:10px">Trails</div>' +
    '<div class="legend-r"><span class="legend-s" style="background:#689f99"></span>Trail</div>' +
    '<div class="legend-r"><span class="legend-s" style="background:#86593c"></span>Near observations</div>' +
    '<div class="legend-t" style="margin-top:10px">Points</div>' +
    '<div class="legend-r"><span class="legend-s" style="background:#85bb40;border-radius:50%"></span>iNaturalist</div>';
  return d;
};
leg.addTo(map);

/* ‚ïê‚ïê‚ïê TOGGLES ‚ïê‚ïê‚ïê */
$('tWS').addEventListener('change', () => { if (!lWS) return; $('tWS').checked ? lWS.addTo(map) : map.removeLayer(lWS); });
$('tPt').addEventListener('change', () => { if (!lObs) return; $('tPt').checked ? lObs.addTo(map) : map.removeLayer(lObs); });
$('tHt').addEventListener('change', () => { if (!lHeat) return; $('tHt').checked ? lHeat.addTo(map) : map.removeLayer(lHeat); });

console.log('üåø NH Biodiversity Explorer ready');
})();
</script>
</body>
</html>
