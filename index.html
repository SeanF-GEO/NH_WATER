<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>NH Biodiversity Explorer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root {
  --void: #05060d; --abyss: #0a0d1a; --deep: #0e1225; --shade: #151a32;
  --murk: #1c2340; --slate: #2a3358;
  --neon: #00e8b4; --neon-dim: #00b48c; --glow: #00ffc8;
  --violet: #8b5cf6; --violet-dim: #6d3fd4;
  --ember: #f97316; --blood: #dc2626;
  --frost: #e8edf8; --silver: #8892b0; --ash: #4a5280;
  --text1: #e2e8f4; --text2: #8892b0; --text3: #4a5280;
  --bdr: #1c2340; --bdr2: #2a3358;
  --sp1: #00e8b4; --sp2: #f97316; --sp3: #e84393;
  --fd: 'Cinzel', Georgia, serif; --fb: 'Rajdhani', system-ui, sans-serif;
  --sb: 420px; --rad: 8px; --ease: cubic-bezier(.25,.46,.45,.94);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:var(--fb);background:var(--void);color:var(--text1);-webkit-font-smoothing:antialiased}

.sidebar{position:fixed;top:0;left:0;width:var(--sb);height:100vh;background:linear-gradient(180deg,var(--abyss),var(--deep));border-right:1px solid var(--bdr2);display:flex;flex-direction:column;z-index:1000;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--slate) transparent}
.sidebar::-webkit-scrollbar{width:5px}.sidebar::-webkit-scrollbar-thumb{background:var(--slate);border-radius:3px}

.sb-hd{padding:34px 30px 28px;border-bottom:1px solid var(--bdr2);position:relative;overflow:hidden}
.sb-hd::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 20% 90%,rgba(0,232,180,.06),transparent 50%),radial-gradient(ellipse at 80% 10%,rgba(139,92,246,.06),transparent 50%);pointer-events:none}
.sb-hd::after{content:'';position:absolute;bottom:0;left:30px;right:30px;height:1px;background:linear-gradient(90deg,transparent,var(--neon-dim),transparent);opacity:.3}
.hd-eye{font-family:var(--fb);font-size:.78rem;font-weight:600;letter-spacing:.3em;text-transform:uppercase;color:var(--neon);margin-bottom:10px;position:relative}
.hd-t{font-family:var(--fd);font-size:1.9rem;font-weight:700;line-height:1.1;color:var(--frost);position:relative;text-shadow:0 0 40px rgba(0,232,180,.08)}
.hd-s{font-family:var(--fb);font-size:1.2rem;font-weight:300;color:var(--silver);margin-top:6px;position:relative;letter-spacing:.05em}

.pnl{padding:24px 30px;border-bottom:1px solid var(--bdr)}
.pnl-lb{display:flex;align-items:center;gap:12px;font-size:1.1rem;font-weight:600;letter-spacing:.18em;text-transform:uppercase;color:var(--ash);margin-bottom:16px}
.sn{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;color:var(--silver);border:1px solid var(--bdr2);background:var(--shade)}
.sn.on{background:transparent;color:var(--neon);border-color:var(--neon);box-shadow:0 0 8px rgba(0,232,180,.2)}

.sw{position:relative}
.si-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);color:var(--ash);pointer-events:none;transition:color .2s}
.sinp{width:100%;padding:16px 20px 16px 50px;background:var(--shade);border:1px solid var(--bdr2);border-radius:var(--rad);color:var(--text1);font-family:var(--fb);font-size:1.3rem;font-weight:400;outline:none;transition:border-color .3s,box-shadow .3s;letter-spacing:.02em}
.sinp::placeholder{color:var(--ash);font-weight:300}
.sinp:focus{border-color:var(--neon);box-shadow:0 0 0 3px rgba(0,232,180,.1),0 0 20px rgba(0,232,180,.05)}
.sinp:focus~.si-icon{color:var(--neon)}
.shint{font-size:1.1rem;color:var(--ash);margin-top:12px;font-weight:300;letter-spacing:.02em}

.sugs{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--shade);border:1px solid var(--bdr2);border-radius:var(--rad);max-height:420px;overflow-y:auto;z-index:100;box-shadow:0 20px 60px rgba(0,0,0,.6);display:none}
.sugs.open{display:block}
.sg{padding:14px 20px;cursor:pointer;border-bottom:1px solid var(--bdr);transition:background .12s;display:flex;align-items:center;gap:16px}
.sg:last-child{border-bottom:none}.sg:hover{background:var(--murk)}
.sg-img{width:54px;height:54px;border-radius:6px;object-fit:cover;background:var(--deep);flex-shrink:0;border:1px solid var(--bdr2)}
.sg-info{flex:1;min-width:0}
.sg-c{font-size:1.25rem;font-weight:600;color:var(--frost);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sg-s{font-size:1.1rem;color:var(--silver);font-weight:300}
.sg-r{font-size:.82rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--neon);background:rgba(0,232,180,.08);padding:4px 10px;border-radius:3px;border:1px solid rgba(0,232,180,.15);flex-shrink:0}

/* ‚ïê‚ïê‚ïê SPECIES BADGES ‚ïê‚ïê‚ïê */
.badge-list{margin-top:16px;display:flex;flex-direction:column;gap:10px}
.badge{padding:14px 18px;background:rgba(0,232,180,.04);border:1px solid rgba(0,232,180,.15);border-radius:var(--rad);display:flex;align-items:center;gap:14px;animation:fu .35s var(--ease)}
@keyframes fu{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.b-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;box-shadow:0 0 8px currentColor}
.b-img{width:48px;height:48px;border-radius:6px;object-fit:cover;background:var(--deep);border:1px solid var(--bdr2)}
.b-txt{flex:1;min-width:0}
.b-c{font-weight:600;font-size:1.2rem}
.b-s{font-size:1rem;color:var(--silver);font-weight:300}
.b-x{background:none;border:none;color:var(--ash);cursor:pointer;font-size:1.6rem;line-height:1;padding:4px;border-radius:4px;transition:color .15s}
.b-x:hover{color:var(--blood)}
.badge-full{font-size:1.05rem;color:var(--ash);padding:10px 0;font-weight:400;font-style:italic}

.tg{display:flex;flex-direction:column;gap:8px}
.tl{display:flex;align-items:center;gap:14px;cursor:pointer;font-size:1.25rem;font-weight:400;color:var(--text2);user-select:none;padding:6px 0}
.tl input{display:none}
.tt{width:42px;height:22px;background:var(--deep);border:1px solid var(--bdr2);border-radius:11px;position:relative;flex-shrink:0;transition:background .25s,border-color .25s}
.tt::after{content:'';position:absolute;top:3px;left:3px;width:14px;height:14px;background:var(--ash);border-radius:50%;transition:transform .25s var(--ease),background .25s,box-shadow .25s}
.tl input:checked+.tt{background:rgba(0,232,180,.1);border-color:var(--neon-dim)}
.tl input:checked+.tt::after{transform:translateX(20px);background:var(--neon);box-shadow:0 0 8px rgba(0,232,180,.4)}

.rp{display:none}.rp.vis{display:block}
.rs{margin-bottom:22px}
.rs h4{font-family:var(--fd);font-size:1.3rem;font-weight:600;color:var(--frost);margin-bottom:14px}
.rr{display:flex;justify-content:space-between;align-items:baseline;cursor:pointer;transition:background .1s;border-radius:4px;padding:8px 10px;margin:0 -10px}
.rr:hover{background:rgba(0,232,180,.04)}.rr:hover .rn{color:var(--frost)}
.rn{color:var(--text2);font-size:1.2rem;max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color .15s;font-weight:400}
.rv{font-weight:700;font-size:1.2rem;font-variant-numeric:tabular-nums;color:var(--ember)}
.rb{height:4px;background:var(--bdr);border-radius:2px;margin:4px 0 12px;overflow:hidden}
.rb-f{height:100%;border-radius:2px;transition:width .6s var(--ease)}

.hero-card{padding:16px 20px;background:linear-gradient(135deg,rgba(0,232,180,.06),rgba(139,92,246,.04));border:1px solid rgba(0,232,180,.2);border-radius:var(--rad);margin-bottom:16px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.hero-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--neon),transparent);opacity:.3}
.hero-card:hover{border-color:var(--neon);box-shadow:0 0 20px rgba(0,232,180,.08)}
.hero-name{font-family:var(--fd);font-size:1.3rem;font-weight:600;color:var(--neon)}
.hero-sub{font-size:1.15rem;color:var(--silver);font-weight:400;margin-top:3px}
.hero-hint{font-size:1.05rem;color:var(--violet);margin-top:6px;font-weight:500}

.back-btn{display:none;margin-bottom:16px;padding:12px 18px;background:transparent;border:1px solid var(--bdr2);border-radius:var(--rad);color:var(--silver);font-family:var(--fb);font-size:1.2rem;font-weight:500;cursor:pointer;transition:all .2s;width:100%;text-align:left;letter-spacing:.03em}
.back-btn:hover{border-color:var(--violet);color:var(--violet);background:rgba(139,92,246,.04)}
.back-btn.vis{display:block}

.trail-info{margin-top:16px;padding:16px 20px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15);border-radius:var(--rad);display:none}
.trail-info.vis{display:block}
.trail-info h5{font-family:var(--fd);font-size:1.2rem;font-weight:600;color:var(--violet);margin-bottom:10px}
.trail-info .trail-count{font-size:1.1rem;color:var(--silver);margin-bottom:10px;font-weight:400}

.sb-ft{margin-top:auto;padding:24px 30px;border-top:1px solid var(--bdr2);background:var(--abyss);position:relative}
.sb-ft::before{content:'';position:absolute;top:0;left:30px;right:30px;height:1px;background:linear-gradient(90deg,transparent,var(--violet-dim),transparent);opacity:.2}
.st-r{display:flex;justify-content:space-between}
.stat{text-align:center}
.st-v{display:block;font-family:var(--fd);font-size:1.8rem;font-weight:700;color:var(--ember);line-height:1.2}
.st-l{font-size:.92rem;letter-spacing:.12em;text-transform:uppercase;color:var(--ash);font-weight:600}

#map{position:fixed;top:0;left:var(--sb);right:0;bottom:0;z-index:1;background:var(--void)}
.ld{position:fixed;top:0;left:var(--sb);right:0;bottom:0;background:rgba(5,6,13,.9);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:2000}
.ld.vis{display:flex}
.sp{width:46px;height:46px;border:2px solid var(--bdr2);border-top-color:var(--neon);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 18px}
@keyframes spin{to{transform:rotate(360deg)}}
.lm{font-size:1.3rem;color:var(--silver);font-weight:300;letter-spacing:.05em}

.leaflet-popup-content-wrapper{background:var(--shade)!important;color:var(--text1)!important;border-radius:var(--rad)!important;border:1px solid var(--bdr2)!important;box-shadow:0 16px 50px rgba(0,0,0,.6)!important}
.leaflet-popup-tip{background:var(--shade)!important}
.leaflet-popup-content{font-family:var(--fb)!important;font-size:1.15rem!important;line-height:1.6!important;margin:16px 20px!important}
.leaflet-popup-content strong{color:var(--neon);font-family:var(--fd);font-size:1.25rem}
.leaflet-popup-content a{color:var(--violet);text-decoration:none;font-weight:500;font-size:1.1rem}
.leaflet-popup-content a:hover{text-decoration:underline}
.leaflet-popup-close-button{color:var(--ash)!important;font-size:22px!important}
.leaflet-control-zoom a{background:var(--shade)!important;color:var(--frost)!important;border-color:var(--bdr2)!important;font-size:18px!important}
.leaflet-control-zoom a:hover{background:var(--murk)!important}
.leaflet-control-attribution{background:rgba(5,6,13,.92)!important;color:var(--ash)!important;font-size:.7rem!important}
.leaflet-control-attribution a{color:var(--silver)!important}

.legend{background:var(--shade);border:1px solid var(--bdr2);border-radius:var(--rad);padding:18px 22px;font-size:1.05rem;color:var(--text2);line-height:2.2;font-weight:400}
.legend-t{font-weight:700;font-size:.85rem;letter-spacing:.14em;text-transform:uppercase;color:var(--ash);margin-bottom:4px}
.legend-r{display:flex;align-items:center;gap:12px}
.legend-s{width:24px;height:14px;border-radius:3px;flex-shrink:0;border:1px solid rgba(255,255,255,.06)}
.legend-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0}

.ws-tip{background:var(--shade)!important;color:var(--frost)!important;border:1px solid var(--neon-dim)!important;border-radius:6px!important;padding:8px 16px!important;font-family:var(--fb)!important;font-size:1.15rem!important;font-weight:600!important;box-shadow:0 0 20px rgba(0,232,180,.1)!important}
.trail-tip{background:rgba(139,92,246,.92)!important;color:#fff!important;border:none!important;border-radius:4px!important;padding:5px 12px!important;font-family:var(--fb)!important;font-size:1.05rem!important;font-weight:600!important;box-shadow:0 4px 12px rgba(139,92,246,.3)!important;white-space:nowrap!important}

/* ‚ïê‚ïê‚ïê 3D MODE ‚ïê‚ïê‚ïê */
.mode-toggle{display:flex;gap:0;margin-bottom:16px;border-radius:var(--rad);overflow:hidden;border:1px solid var(--bdr2)}
.mode-btn{flex:1;padding:12px 0;text-align:center;font-family:var(--fb);font-size:1.15rem;font-weight:600;letter-spacing:.06em;cursor:pointer;border:none;transition:all .25s;background:var(--shade);color:var(--ash)}
.mode-btn:hover{color:var(--silver);background:var(--murk)}
.mode-btn.active{background:linear-gradient(135deg,rgba(0,232,180,.12),rgba(139,92,246,.08));color:var(--neon);box-shadow:inset 0 -2px 0 var(--neon)}
#map3d{position:fixed;top:0;left:var(--sb);right:0;bottom:0;z-index:1;background:var(--void);display:none}
#map3d.active{display:block}
#map.hidden{display:none}
.maplibregl-popup-content{background:var(--shade)!important;color:var(--text1)!important;border-radius:var(--rad)!important;border:1px solid var(--bdr2)!important;box-shadow:0 16px 50px rgba(0,0,0,.6)!important;font-family:var(--fb)!important;font-size:1.1rem!important;padding:16px 20px!important}
.maplibregl-popup-content strong{color:var(--neon);font-family:var(--fd);font-size:1.2rem}
.maplibregl-popup-tip{border-top-color:var(--shade)!important}
.maplibregl-popup-close-button{color:var(--ash)!important;font-size:20px!important;padding:4px 8px!important}
.maplibregl-ctrl-group{background:var(--shade)!important;border:1px solid var(--bdr2)!important}
.maplibregl-ctrl-group button{color:var(--frost)!important}
.maplibregl-ctrl-group button+button{border-top:1px solid var(--bdr2)!important}
.maplibregl-ctrl-attrib{background:rgba(5,6,13,.92)!important;color:var(--ash)!important;font-size:.7rem!important}
.maplibregl-ctrl-attrib a{color:var(--silver)!important}
.terrain-label{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;background:var(--shade);border:1px solid var(--neon-dim);border-radius:var(--rad);padding:10px 20px;font-family:var(--fb);font-size:1.05rem;color:var(--silver);pointer-events:none;box-shadow:0 0 20px rgba(0,232,180,.1);display:none}
#map3d.active .terrain-label{display:block}

@media(max-width:900px){:root{--sb:100vw}.sidebar{width:100%;height:auto;max-height:42vh;position:relative}#map,#map3d{position:relative;left:0;height:58vh}body{overflow-y:auto}.ld{left:0}}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="sb-hd">
    <div class="hd-eye">New Hampshire &amp; Vermont</div>
    <h1 class="hd-t">Biodiversity Explorer</h1>
    <p class="hd-s">Watersheds, Wildlife &amp; Trails</p>
  </div>
  <div class="pnl">
    <label class="pnl-lb"><span class="sn on">1</span>Find Species</label>
    <div class="sw">
      <svg class="si-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
      <input type="text" id="inp" class="sinp" placeholder="Black Bear, Moose, Bald Eagle‚Ä¶" autocomplete="off"/>
      <div id="sugs" class="sugs"></div>
    </div>
    <div class="shint">Search up to 3 species at a time</div>
    <div id="badgeList" class="badge-list"></div>
  </div>
  <div class="pnl">
    <label class="pnl-lb"><span class="sn">2</span>Layers</label>
    <div class="mode-toggle">
      <button class="mode-btn active" id="btn2d">2D Map</button>
      <button class="mode-btn" id="btn3d">3D Terrain</button>
    </div>
    <div class="tg" id="layerToggles2d">
      <label class="tl"><input type="checkbox" id="tWS" checked/><span class="tt"></span><span class="tl-lb">Watersheds</span></label>
      <label class="tl"><input type="checkbox" id="tPt" checked/><span class="tt"></span><span class="tl-lb">Observation Points</span></label>
    </div>
  </div>
  <div class="pnl rp" id="resP">
    <label class="pnl-lb"><span class="sn on">3</span>Results</label>
    <button id="backBtn" class="back-btn">&#8592; Back to all watersheds</button>
    <div id="resC"></div>
    <div id="trailInfo" class="trail-info">
      <h5 id="trailTitle">Trails</h5>
      <div id="trailCount" class="trail-count"></div>
    </div>
  </div>
  <div class="sb-ft">
    <div class="st-r">
      <div class="stat"><span class="st-v" id="sO">&mdash;</span><span class="st-l">Observations</span></div>
      <div class="stat"><span class="st-v" id="sW">&mdash;</span><span class="st-l">Watersheds</span></div>
      <div class="stat"><span class="st-v" id="sT">&mdash;</span><span class="st-l">Trails</span></div>
    </div>
  </div>
</aside>
<div id="map"></div>
<div id="map3d">
  <div class="terrain-label" id="terrainLabel">Scroll to zoom &middot; Right-drag to rotate &middot; Click a watershed to explore</div>
</div>
<div id="ld" class="ld"><div><div class="sp"></div><p class="lm" id="lmsg">Loading‚Ä¶</p></div></div>

<script>
(async function(){
'use strict';

const BBOX={swlat:42.72,swlng:-73.44,nelat:45.31,nelng:-70.70};
const INAT='https://api.inaturalist.org/v1';
const SP_COLORS=['#00e8b4','#f97316','#e84393'];

const TRAIL_FILES={
  'Ammonoosuc River-Connecticut River':'Trails_Ammonoosuc_River_Connecticut_River.geojson',
  'Ashuelot River-Connecticut River':'Trails_Ashuelot_River_Connecticut_River.geojson',
  'Black River-Connecticut River':'Trails_Black_River_Connecticut_River.geojson',
  'Contoocook River':'Trails_Contoocook_River.geojson',
  'Headwaters Connecticut River':'Trails_Headwaters_Connecticut_River.geojson',
  'Lower Androscoggin River':'Trails_Lower_Androscoggin_River.geojson',
  'Merrimack River':'Trails_Merrimack_River.geojson',
  'Millers River':'Trails_Millers_River.geojson',
  'Nashua River':'Trails_Nashua_River.geojson',
  'Pemigewasset River':'Trails_Pemigewasset_River.geojson',
  'Piscataqua-Salmon Falls':'Trails_Piscataqua_Salmon_Falls.geojson',
  'Saco River':'Trails_Saco_River.geojson',
  'Upper Androscoggin River':'Trails_Upper_Androscoggin_River.geojson',
  'Waits River-Connecticut River':'Trails_Waits_River_Connecticut_River.geojson',
  'West River-Connecticut River':'Trails_West_River_Connecticut_River.geojson',
  'Winnipesaukee River':'Trails_Winnipesaukee_River.geojson'
};

const WC=[
  '#ff4444','#ff8c1a','#ffd700','#33d17a','#3daee9',
  '#b366ff','#ff6b6b','#ffaa33','#2de6a3','#9d6fff',
  '#ff6600','#1affc6','#ff4444','#50fa7b','#cc66ff',
  '#ff8c1a','#3daee9','#ffd700','#b366ff','#ff6b6b',
  '#33d17a','#ffaa33','#2de6a3','#ff6600','#ff4444'
];

const $=id=>document.getElementById(id);
function sL(m){$('lmsg').textContent=m;$('ld').classList.add('vis')}
function hL(){$('ld').classList.remove('vis')}
async function fj(p){try{const r=await fetch(p);if(!r.ok)throw r.status;return r.json()}catch(e){console.warn('Failed:',p,e);return null}}

/* ‚ïê‚ïê‚ïê REPROJECTION ‚ïê‚ïê‚ïê */
proj4.defs('EPSG:3857','+proj=merc +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +no_defs');
proj4.defs('EPSG:3437','+proj=tmerc +lat_0=42.5 +lon_0=-71.66666666666667 +k=0.999966667 +x_0=300000.0000000001 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs');
function rpc(c,from){if(typeof c[0]==='number')return proj4(from,'EPSG:4326',[c[0],c[1]]);return c.map(x=>rpc(x,from))}
function detectCRS(gj){
  const n=gj?.crs?.properties?.name||'';
  if(n.includes('3857'))return'EPSG:3857';if(n.includes('3437'))return'EPSG:3437';
  if(n.includes('4326')||n.includes('4269'))return null;
  function fc(c){if(typeof c[0]==='number')return c;return fc(c[0])}
  for(const f of(gj.features||[])){if(f.geometry?.coordinates){const c=fc(f.geometry.coordinates);if(c){if(Math.abs(c[0])<=180&&Math.abs(c[1])<=90)return null;if(Math.abs(c[0])>100000)return'EPSG:3857';if(c[0]>50000&&c[0]<2000000)return'EPSG:3437'}}}
  return null;
}
function ensureWGS84(gj){
  if(!gj?.features)return gj;const from=detectCRS(gj);if(!from)return gj;
  const out=JSON.parse(JSON.stringify(gj));
  out.features.forEach(f=>{if(f.geometry?.coordinates)f.geometry.coordinates=rpc(f.geometry.coordinates,from)});
  delete out.crs;return out;
}

const trailCache={};
async function loadTrails(wsName){
  if(trailCache[wsName])return trailCache[wsName];
  const file=TRAIL_FILES[wsName];if(!file)return null;
  const raw=await fj(file);if(!raw)return null;
  const gj=ensureWGS84(raw);
  gj.features.forEach(f=>{f.properties=f.properties||{};if(!f.properties.trailname)f.properties.trailname=f.properties.TRAIL_NAME||f.properties.Name||'Trail'});
  trailCache[wsName]=gj;return gj;
}

/* ‚ïê‚ïê‚ïê LOAD DATA ‚ïê‚ïê‚ïê */
sL('Loading watersheds‚Ä¶');
const wsGJ=ensureWGS84(await fj('nh_vt_8.geojson'));
const stGJ=ensureWGS84(await fj('State.geojson'));
if(!wsGJ){hL();alert('Could not load nh_vt_8.geojson');return}

/* ‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê */
const map=L.map('map',{center:[43.8,-72.1],zoom:8,minZoom:7,maxZoom:18});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; CARTO &copy; OSM',maxZoom:19}).addTo(map);
if(stGJ)L.geoJSON(stGJ,{style:{color:'#2a3358',weight:1.5,opacity:.35,dashArray:'8,5',fill:false},interactive:false}).addTo(map);

const wcm={};
wsGJ.features.forEach((f,i)=>{wcm[f.properties.name]=WC[i%WC.length]});

map.createPane('wsPane');map.getPane('wsPane').style.zIndex=400;
map.createPane('trailPane');map.getPane('trailPane').style.zIndex=450;
map.createPane('pointPane');map.getPane('pointPane').style.zIndex=500;

let lWS=null,lTr=null,activeWatershed=null;

/* ‚ïê‚ïê‚ïê MULTI-SPECIES STATE ‚ïê‚ïê‚ïê */
// Each entry: { sp, obs (FeatureCollection), layer (L.geoJSON), color }
let species=[];  // max 3

function totalObs(){return species.reduce((n,s)=>n+s.obs.features.length,0)}

/* ‚ïê‚ïê‚ïê COUNT OBS PER WATERSHED ‚ïê‚ïê‚ïê */
function countAllObsPerWatershed(){
  wsGJ.features.forEach(f=>{f.properties._oc=0});
  species.forEach(s=>{
    s.obs.features.forEach(pt=>{
      const tp=turf.point(pt.geometry.coordinates);
      for(const f of wsGJ.features){
        try{if(turf.booleanPointInPolygon(tp,f)){f.properties._oc++;break}}catch(e){}
      }
    });
  });
}

/* ‚ïê‚ïê‚ïê ALL WATERSHEDS ‚ïê‚ïê‚ïê */
function showAllWatersheds(fitBounds){
  activeWatershed=null;
  if(lWS){map.removeLayer(lWS);lWS=null}
  if(lTr){map.removeLayer(lTr);lTr=null}
  $('backBtn').classList.remove('vis');
  $('trailInfo').classList.remove('vis');

  lWS=L.geoJSON(wsGJ,{
    pane:'wsPane',
    style:f=>{
      const c=wcm[f.properties.name]||'#00b48c';
      return{fillColor:'transparent',fillOpacity:0,color:c,weight:3.5,opacity:.85};
    },
    onEachFeature:(f,ly)=>{
      ly.on({
        mouseover:e=>{e.target.setStyle({weight:5.5,opacity:1,color:'#00ffc8'});e.target.bringToFront()},
        mouseout:e=>lWS.resetStyle(e.target),
        click:()=>drillIntoWatershed(f.properties.name)
      });
      const oc=f.properties._oc?' ('+f.properties._oc+' obs)':'';
      ly.bindTooltip(f.properties.name+oc,{sticky:true,className:'ws-tip',direction:'top',offset:[0,-10]});
    }
  });
  if($('tWS').checked)lWS.addTo(map);
  if(fitBounds!==false)map.fitBounds(lWS.getBounds(),{padding:[20,20]});
}

/* ‚ïê‚ïê‚ïê DRILL INTO WATERSHED ‚ïê‚ïê‚ïê */
async function drillIntoWatershed(wsName){
  activeWatershed=wsName;
  if(lWS){map.removeLayer(lWS);lWS=null}
  if(lTr){map.removeLayer(lTr);lTr=null}
  const feat=wsGJ.features.find(f=>f.properties.name===wsName);
  if(!feat)return;
  const c=wcm[wsName]||'#00b48c';
  lWS=L.geoJSON(feat,{pane:'wsPane',style:{fillColor:'transparent',fillOpacity:0,color:c,weight:4,opacity:.9},interactive:false});
  lWS.addTo(map);
  map.fitBounds(lWS.getBounds(),{padding:[50,50]});
  $('backBtn').classList.add('vis');

  sL('Loading trails‚Ä¶');
  const trailData=await loadTrails(wsName);
  hL();
  if(!trailData||!trailData.features.length){
    $('trailInfo').classList.add('vis');
    $('trailTitle').textContent=wsName;
    $('trailCount').textContent='No trail data available';
    $('sT').textContent='0';return;
  }
  lTr=L.geoJSON(trailData,{
    pane:'trailPane',
    style:{color:'#8b5cf6',weight:2.5,opacity:.6},
    onEachFeature:(f,ly)=>{
      const p=f.properties;
      const name=p.trailname||'Trail';
      const sys=p.trailsys||'';
      const mi=p.miles?((+p.miles).toFixed(1)+' mi'):'';
      const co=p.community||'';
      const url=p.mapurl?'<br/><a href="'+p.mapurl+'" target="_blank">Trail info &#8594;</a>':'';
      ly.on({
        mouseover:e=>{e.target.setStyle({weight:5,opacity:1,color:'#a78bfa'})},
        mouseout:e=>{lTr.resetStyle(e.target)},
        click:()=>{
          let html='<strong>'+name+'</strong>';
          if(sys)html+='<br/><span style="color:#a78bfa;font-weight:500">'+sys+'</span>';
          if(co||mi)html+='<br/><span style="color:#8892b0">'+co+(co&&mi?' &middot; ':'')+mi+'</span>';
          html+=url;
          ly.bindPopup(html).openPopup();
        }
      });
      ly.bindTooltip(name,{sticky:true,className:'trail-tip',direction:'top',offset:[0,-8]});
    }
  });
  lTr.addTo(map);
  $('trailTitle').textContent=wsName;
  $('trailCount').textContent=trailData.features.length+' trails ‚Äî hover or click for details';
  $('trailInfo').classList.add('vis');
  $('sT').textContent=trailData.features.length;
}

$('backBtn').addEventListener('click',()=>showAllWatersheds());
showAllWatersheds();hL();

/* ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê */
let sTimer;
const inp=$('inp'),sugBox=$('sugs');
inp.addEventListener('input',()=>{
  clearTimeout(sTimer);const q=inp.value.trim();
  if(q.length<2){sugBox.classList.remove('open');return}
  sTimer=setTimeout(async()=>{
    let taxa=[];
    try{const d=await(await fetch(INAT+'/taxa/autocomplete?q='+encodeURIComponent(q)+'&per_page=12&is_active=true')).json();
      taxa=(d.results||[]).map(t=>({id:t.id,sci:t.name,common:t.preferred_common_name||t.english_common_name||t.name,rank:t.rank,icon:t.default_photo?.square_url||''}));
    }catch(e){}
    if(!taxa.length){sugBox.innerHTML='<div style="padding:18px 20px;color:#4a5280;font-size:1.2rem">No species found</div>';sugBox.classList.add('open');return}
    sugBox.innerHTML=taxa.map(t=>
      '<div class="sg" data-id="'+t.id+'" data-sci="'+t.sci+'" data-common="'+t.common+'" data-icon="'+t.icon+'">'+
      (t.icon?'<img class="sg-img" src="'+t.icon+'" alt=""/>':'<div class="sg-img"></div>')+
      '<div class="sg-info"><div class="sg-c">'+t.common+'</div><div class="sg-s">'+t.sci+'</div></div>'+
      '<span class="sg-r">'+t.rank+'</span></div>'
    ).join('');
    sugBox.classList.add('open');
    sugBox.querySelectorAll('.sg').forEach(el=>{
      el.addEventListener('click',()=>addSpecies({id:el.dataset.id,sci:el.dataset.sci,common:el.dataset.common,icon:el.dataset.icon}));
    });
  },300);
});
inp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();const f=sugBox.querySelector('.sg');if(f)f.click()}});
document.addEventListener('click',e=>{if(!e.target.closest('.sw'))sugBox.classList.remove('open')});

/* ‚ïê‚ïê‚ïê ADD SPECIES ‚ïê‚ïê‚ïê */
async function addSpecies(sp){
  sugBox.classList.remove('open');inp.value='';

  // Already added?
  if(species.find(s=>s.sp.id===sp.id))return;

  // Full?
  if(species.length>=3)return;

  const color=SP_COLORS[species.length];
  const entry={sp,obs:{type:'FeatureCollection',features:[]},layer:null,color};
  species.push(entry);
  renderBadges();

  sL('Fetching '+sp.common+' observations‚Ä¶');
  try{
    let all=[];
    for(let pg=1;pg<=5;pg++){
      const d=await(await fetch(INAT+'/observations?taxon_id='+sp.id+
        '&swlat='+BBOX.swlat+'&swlng='+BBOX.swlng+'&nelat='+BBOX.nelat+'&nelng='+BBOX.nelng+
        '&quality_grade=research,needs_id&per_page=200&page='+pg+'&order=desc&order_by=observed_on')).json();
      const r=d.results||[];all=all.concat(r);if(r.length<200)break;
    }
    const feats=[];
    all.filter(o=>o.geojson).forEach(o=>{
      feats.push({type:'Feature',
        geometry:{type:'Point',coordinates:[+o.geojson.coordinates[0],+o.geojson.coordinates[1]]},
        properties:{id:o.id,species:o.taxon?.name||'',common:o.taxon?.preferred_common_name||'',
          date:o.observed_on||'',user:o.user?.login||'',
          photo:o.photos?.[0]?.url?.replace('square','small')||'',
          uri:o.uri||'https://www.inaturalist.org/observations/'+o.id,
          _color:color,_spCommon:sp.common}
      });
    });
    entry.obs={type:'FeatureCollection',features:feats};
    console.log(sp.common+':',feats.length,'observations');
  }catch(e){console.error(e)}

  rebuildPoints();
  hL();
}

/* ‚ïê‚ïê‚ïê REMOVE SPECIES ‚ïê‚ïê‚ïê */
function removeSpecies(spId){
  const idx=species.findIndex(s=>s.sp.id===spId);
  if(idx<0)return;
  if(species[idx].layer){map.removeLayer(species[idx].layer)}
  species.splice(idx,1);
  // Reassign colors
  species.forEach((s,i)=>{
    s.color=SP_COLORS[i];
    s.obs.features.forEach(f=>{f.properties._color=s.color;f.properties._spCommon=s.sp.common});
  });
  renderBadges();
  rebuildPoints();
  if(species.length===0){
    $('resP').classList.remove('vis');
    $('sO').textContent='‚Äî';$('sW').textContent='‚Äî';
  }
}

/* ‚ïê‚ïê‚ïê RENDER BADGES ‚ïê‚ïê‚ïê */
function renderBadges(){
  const bl=$('badgeList');
  let html='';
  species.forEach(s=>{
    html+='<div class="badge" style="border-color:'+s.color+'30">'+
      '<div class="b-dot" style="color:'+s.color+';background:'+s.color+'"></div>'+
      (s.sp.icon?'<img class="b-img" src="'+s.sp.icon+'" alt=""/>':'')+
      '<div class="b-txt"><div class="b-c" style="color:'+s.color+'">'+s.sp.common+'</div><div class="b-s">'+s.sp.sci+'</div></div>'+
      '<button class="b-x" onclick="window._removeSp(\''+s.sp.id+'\')">&times;</button></div>';
  });
  if(species.length>=3)html+='<div class="badge-full">Maximum 3 species reached</div>';
  bl.innerHTML=html;
  // Update legend
  for(let i=0;i<3;i++){
    const el=document.getElementById('legSp'+(i+1));
    const nel=document.getElementById('legN'+(i+1));
    if(el){
      if(species[i]){el.style.display='flex';nel.textContent=species[i].sp.common}
      else{el.style.display='none';nel.textContent='‚Äî'}
    }
  }
}
window._removeSp=function(id){removeSpecies(id)};

/* ‚ïê‚ïê‚ïê REBUILD ALL POINTS ‚ïê‚ïê‚ïê */
function rebuildPoints(){
  // Remove old layers
  species.forEach(s=>{if(s.layer){map.removeLayer(s.layer);s.layer=null}});

  // Count per watershed
  countAllObsPerWatershed();

  // Rebuild watershed layer to update tooltip counts
  if(activeWatershed){
    // stay drilled in, just update counts
  } else {
    showAllWatersheds(false);
  }

  // Create point layers for each species
  species.forEach(s=>{
    if(!s.obs.features.length)return;
    s.layer=L.geoJSON(s.obs,{
      pane:'pointPane',
      pointToLayer:(f,ll)=>L.circleMarker(ll,{
        radius:6,fillColor:s.color,color:'#05060d',weight:1.5,fillOpacity:.8
      }),
      onEachFeature:(f,ly)=>{
        const p=f.properties;
        const ph=p.photo?'<img src="'+p.photo+'" style="width:100%;max-height:120px;object-fit:cover;border-radius:6px;margin-bottom:10px"/>':'';
        ly.bindPopup(ph+'<strong>'+(p.common||p.species)+'</strong><br/><span style="color:#8892b0">'+p.species+'</span><br/><span style="color:#4a5280">'+(p.date||'')+(p.user?' &middot; '+p.user:'')+'</span><br/><a href="'+p.uri+'" target="_blank">View on iNaturalist &#8594;</a>');
      }
    });
    if($('tPt').checked)s.layer.addTo(map);
  });

  // Results
  buildResults();

  $('sO').textContent=totalObs().toLocaleString();
  const wsWithObs=wsGJ.features.filter(f=>f.properties._oc>0).length;
  $('sW').textContent=wsWithObs;
}

/* ‚ïê‚ïê‚ïê BUILD RESULTS ‚ïê‚ïê‚ïê */
function buildResults(){
  if(!species.length){$('resP').classList.remove('vis');return}

  const topW=[...wsGJ.features].filter(f=>f.properties._oc>0).sort((a,b)=>b.properties._oc-a.properties._oc).slice(0,8);
  if(!topW.length){
    $('resC').innerHTML='<div style="font-size:1.15rem;color:#4a5280;padding:10px 0">No observations found in the region</div>';
    $('resP').classList.add('vis');return;
  }
  const mW=topW[0]?.properties._oc||1;

  let h='<div class="rs">';
  /* Top watershed card */
  const top=topW[0];
  const sn=top.properties.name.replace(/'/g,"\\'");
  h+='<h4>Top Watershed</h4>';
  h+='<div class="hero-card" onclick="document.dispatchEvent(new CustomEvent(\'wsClick\',{detail:\''+sn+'\'}))">';
  h+='<div class="hero-name">'+top.properties.name+'</div>';
  h+='<div class="hero-sub">'+top.properties._oc+' observations</div>';
  h+='<div class="hero-hint">Click to explore trails &#8594;</div></div>';

  h+='<h4>Watersheds with Sightings</h4>';
  topW.forEach(f=>{
    const pct=(f.properties._oc/mW*100).toFixed(0);
    const sn2=f.properties.name.replace(/'/g,"\\'");
    h+='<div class="rr" onclick="document.dispatchEvent(new CustomEvent(\'wsClick\',{detail:\''+sn2+'\'}))">';
    h+='<span class="rn">'+f.properties.name+'</span><span class="rv">'+f.properties._oc+'</span></div>';
    h+='<div class="rb"><div class="rb-f" style="width:'+pct+'%;background:'+((f===topW[0])?'#f97316':'#2a3358')+'"></div></div>';
  });
  h+='</div>';

  $('resC').innerHTML=h;
  $('resP').classList.add('vis');
}

document.addEventListener('wsClick',e=>drillIntoWatershed(e.detail));

/* ‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê */
const leg=L.control({position:'bottomright'});
leg.onAdd=function(){
  const d=L.DomUtil.create('div','legend');
  let html='<div class="legend-t">Species</div>';
  html+='<div class="legend-r" id="legSp1"><span class="legend-dot" style="background:#00e8b4"></span><span id="legN1">‚Äî</span></div>';
  html+='<div class="legend-r" id="legSp2" style="display:none"><span class="legend-dot" style="background:#f97316"></span><span id="legN2">‚Äî</span></div>';
  html+='<div class="legend-r" id="legSp3" style="display:none"><span class="legend-dot" style="background:#e84393"></span><span id="legN3">‚Äî</span></div>';
  html+='<div class="legend-t" style="margin-top:12px">Layers</div>';
  html+='<div class="legend-r"><span class="legend-s" style="background:#8b5cf6"></span>Trails</div>';
  d.innerHTML=html;
  return d;
};
leg.addTo(map);

// Update legend when species change
function updateLegend(){
  for(let i=0;i<3;i++){
    const el=document.getElementById('legSp'+(i+1));
    const nel=document.getElementById('legN'+(i+1));
    if(el){
      if(species[i]){el.style.display='flex';nel.textContent=species[i].sp.common}
      else{el.style.display='none';nel.textContent='‚Äî'}
    }
  }
}

/* ‚ïê‚ïê‚ïê TOGGLES ‚ïê‚ïê‚ïê */
$('tWS').addEventListener('change',()=>{if(!lWS)return;$('tWS').checked?lWS.addTo(map):map.removeLayer(lWS)});
$('tPt').addEventListener('change',()=>{
  species.forEach(s=>{
    if(!s.layer)return;
    $('tPt').checked?s.layer.addTo(map):map.removeLayer(s.layer);
  });
});

console.log('üåø NH Biodiversity Explorer ready');

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   3D TERRAIN VIEWER MODULE
   Uses MapLibre GL JS + free AWS/Mapzen terrain tiles
   No API key required ‚Äî fully static
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let map3d = null;
let mode3d = false;
let highlighted3dWs = null;

const WS_BORDER_COLORS_3D = {};
wsGJ.features.forEach((f,i) => { WS_BORDER_COLORS_3D[f.properties.name] = WC[i % WC.length]; });

function init3dMap() {
  if (map3d) return; // already initialized

  map3d = new maplibregl.Map({
    container: 'map3d',
    style: {
      version: 8,
      glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
      sources: {
        'carto-dark': {
          type: 'raster',
          tiles: [
            'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png',
            'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'
          ],
          tileSize: 256,
          attribution: '&copy; CARTO &copy; OSM'
        },
        'terrainSource': {
          type: 'raster-dem',
          tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
          encoding: 'terrarium',
          tileSize: 256,
          maxzoom: 15
        },
        'hillshadeSource': {
          type: 'raster-dem',
          tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
          encoding: 'terrarium',
          tileSize: 256,
          maxzoom: 15
        }
      },
      layers: [
        {
          id: 'carto-tiles',
          type: 'raster',
          source: 'carto-dark',
          minzoom: 0,
          maxzoom: 19
        },
        {
          id: 'hillshade',
          type: 'hillshade',
          source: 'hillshadeSource',
          paint: {
            'hillshade-exaggeration': 0.35,
            'hillshade-shadow-color': '#000000',
            'hillshade-highlight-color': '#ffffff',
            'hillshade-accent-color': '#0a0d1a',
            'hillshade-illumination-direction': 315
          }
        }
      ],
      terrain: {
        source: 'terrainSource',
        exaggeration: 2.8
      },
      sky: {
        'sky-color': '#05060d',
        'horizon-color': '#151a32',
        'fog-color': '#0a0d1a',
        'sky-horizon-blend': 0.5,
        'horizon-fog-blend': 0.8
      }
    },
    center: [-72.1, 43.8],
    zoom: 7.8,
    pitch: 55,
    bearing: -15,
    maxPitch: 80,
    minZoom: 6,
    maxZoom: 16
  });

  map3d.addControl(new maplibregl.NavigationControl({ showCompass: true, visualizePitch: true }), 'top-right');

  map3d.on('load', () => {
    // Add HUC8 watershed source
    map3d.addSource('watersheds', {
      type: 'geojson',
      data: wsGJ
    });

    // Fill layer ‚Äî semi-transparent
    map3d.addLayer({
      id: 'ws-fill',
      type: 'fill',
      source: 'watersheds',
      paint: {
        'fill-color': 'rgba(0,232,180,0.04)',
        'fill-opacity': 0.6
      }
    });

    // Highlighted fill ‚Äî initially hidden via filter
    map3d.addLayer({
      id: 'ws-fill-highlight',
      type: 'fill',
      source: 'watersheds',
      paint: {
        'fill-color': 'rgba(0,232,180,0.12)',
        'fill-opacity': 0.8
      },
      filter: ['==', 'name', '']
    });

    // Border lines
    map3d.addLayer({
      id: 'ws-lines',
      type: 'line',
      source: 'watersheds',
      paint: {
        'line-color': ['match', ['get', 'name'],
          ...wsGJ.features.flatMap(f => [f.properties.name, WS_BORDER_COLORS_3D[f.properties.name] || '#00e8b4']),
          '#00e8b4'
        ],
        'line-width': 2.5,
        'line-opacity': 0.85
      }
    });

    // Highlight border
    map3d.addLayer({
      id: 'ws-lines-highlight',
      type: 'line',
      source: 'watersheds',
      paint: {
        'line-color': '#00ffc8',
        'line-width': 5,
        'line-opacity': 1
      },
      filter: ['==', 'name', '']
    });

    // Watershed name labels
    map3d.addLayer({
      id: 'ws-labels',
      type: 'symbol',
      source: 'watersheds',
      layout: {
        'text-field': ['get', 'name'],
        'text-size': 13,
        'text-font': ['Open Sans Regular'],
        'text-anchor': 'center',
        'text-max-width': 10,
        'text-allow-overlap': false
      },
      paint: {
        'text-color': '#c8cdea',
        'text-halo-color': 'rgba(5,6,13,0.9)',
        'text-halo-width': 2
      }
    });

    // Cursor and click handling
    map3d.on('mouseenter', 'ws-fill', () => { map3d.getCanvas().style.cursor = 'pointer'; });
    map3d.on('mouseleave', 'ws-fill', () => { map3d.getCanvas().style.cursor = ''; });

    map3d.on('click', 'ws-fill', (e) => {
      if (!e.features.length) return;
      const feat = e.features[0];
      const name = feat.properties.name;
      zoom3dToWatershed(name);
    });

    // Click off watersheds to reset
    map3d.on('click', (e) => {
      const features = map3d.queryRenderedFeatures(e.point, { layers: ['ws-fill'] });
      if (!features.length && highlighted3dWs) {
        reset3dView();
      }
    });

    console.log('üèîÔ∏è 3D Terrain viewer loaded');
    // Fade out the hint label after a few seconds
    setTimeout(() => {
      const lbl = $('terrainLabel');
      if (lbl) { lbl.style.transition = 'opacity 1.5s'; lbl.style.opacity = '0'; setTimeout(() => lbl.style.display = 'none', 1500); }
    }, 5000);
  });
}

function zoom3dToWatershed(name) {
  if (!map3d) return;
  highlighted3dWs = name;

  // Set highlight filters
  map3d.setFilter('ws-fill-highlight', ['==', 'name', name]);
  map3d.setFilter('ws-lines-highlight', ['==', 'name', name]);

  // Calculate bounds of the clicked watershed
  const feat = wsGJ.features.find(f => f.properties.name === name);
  if (!feat) return;

  const bounds = turf.bbox(feat);
  // [minX, minY, maxX, maxY] = [west, south, east, north]

  map3d.flyTo({
    center: [(bounds[0] + bounds[2]) / 2, (bounds[1] + bounds[3]) / 2],
    zoom: 10,
    pitch: 62,
    bearing: map3d.getBearing(),
    duration: 2000,
    essential: true
  });

  // Popup with obs count
  const oc = feat.properties._oc || 0;
  const center = turf.centerOfMass(feat);
  const lngLat = center.geometry.coordinates;

  new maplibregl.Popup({ offset: 10, closeButton: true, maxWidth: '320px' })
    .setLngLat(lngLat)
    .setHTML(
      '<strong>' + name + '</strong>' +
      (feat.properties.huc8 ? '<br/><span style="color:#4a5280">HUC8: ' + feat.properties.huc8 + '</span>' : '') +
      (oc ? '<br/><span style="color:#8892b0">' + oc + ' observations</span>' : '')
    )
    .addTo(map3d);
}

function reset3dView() {
  if (!map3d) return;
  highlighted3dWs = null;
  map3d.setFilter('ws-fill-highlight', ['==', 'name', '']);
  map3d.setFilter('ws-lines-highlight', ['==', 'name', '']);

  map3d.flyTo({
    center: [-72.1, 43.8],
    zoom: 7.8,
    pitch: 55,
    bearing: -15,
    duration: 1800
  });
}

/* ‚ïê‚ïê‚ïê MODE TOGGLE ‚ïê‚ïê‚ïê */
$('btn2d').addEventListener('click', () => {
  if (!mode3d) return;
  mode3d = false;
  $('btn2d').classList.add('active');
  $('btn3d').classList.remove('active');
  $('map').classList.remove('hidden');
  $('map3d').classList.remove('active');
  $('layerToggles2d').style.display = '';
  // Refresh Leaflet map size since it was hidden
  map.invalidateSize();
});

$('btn3d').addEventListener('click', () => {
  if (mode3d) return;
  mode3d = true;
  $('btn3d').classList.add('active');
  $('btn2d').classList.remove('active');
  $('map').classList.add('hidden');
  $('map3d').classList.add('active');
  $('layerToggles2d').style.display = 'none';
  // Initialize 3D map on first use
  init3dMap();
  if (map3d) {
    map3d.resize();
    // Sync watershed obs counts to 3D if available
    if (map3d.getSource('watersheds')) {
      map3d.getSource('watersheds').setData(wsGJ);
    }
  }
});
})();
</script>
</body>
</html>
